<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>设计</title>

	<!-- common styles -->
	<link rel="stylesheet" type="text/css" href="../css/Normalize.css.css"/>
	<link rel="stylesheet" type="text/css" href="../css/index.css"/>
	<link rel="stylesheet" type="text/css" href="../css/navbar.css"/>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
				integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

	<!-- custom styles -->
	<link rel="stylesheet" type="text/css" href="../css/login&register.css">

	<!-- common js -->
	<script src="../js/storage.js"></script>
	<script src="https://code.jquery.com/jquery-3.4.1.js" integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU="
					crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
					integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
					crossorigin="anonymous"></script>

	<script src="../js/helpers.js"></script>
	<script src="../js/http.js"></script>
	<script src="../api/user.js"></script>
</head>

<body>
<nav>
	<h1 class="logo">
		<img src="../images/logo.png"/>
	</h1>
	<div>
		<a href="index.html">首页</a>
	</div>
	<div>
		<a href="">素材网站</a>
	</div>
	<div>
		<a href="">使用帮助</a>
	</div>
	<div>
		<a href="">常见问题解答</a>
	</div>
	<div>
		<a href="">关于我们</a>
	</div>
	<div>
		<a href="">联系我们</a>
	</div>
	<div class="register">
		<a href="login.html">登录</a>
	</div>
</nav>

<main class="content">
	<h1>用户注册</h1>
	<h3>整合全网平面素材资源,VIP通道下载速度拉满</h3>
	<div class="Login-box">
		<div class="Login-content">
			<form>
				<div class="form-item">
					<p>邮箱</p>
					<input type="email" name="email" class="iconfont" placeholder="&#xe603;&nbsp;请输入邮箱"/>
					<span class="tips">支持所有邮箱格式</span>
				</div>

				<div class="form-item">
					<p>密码</p>
					<input type="password" name="password" class="iconfont" placeholder="&#xe64b;&nbsp;请输入密码"/>
					<span class="tips">16位大小写字母或数字组成</span>
				</div>

				<div class="form-item">
					<p>确认密码</p>
					<input type="password" name="password_confirm" class="iconfont" placeholder="&#xe64b;&nbsp;请确认密码"/>
					<span class="tips">16位大小写字母或数字组成</span>
				</div>

				<div class="Login-button clearfix">
					<a href="">忘记密码？</a>
					<button type="button" value="提交" onclick="handleSubmit()">注册</button>
				</div>
			</form>
		</div>
	</div>
</main>
</body>

<script>
  async function handleSubmit() {
    const data = _helpers.getFormData('form')

    try {
      await validate(data)
      await _api.user.register(data)

      // TODO 提示注册成功

      alert('注册成功')

      // location.href = 'index.html'
    } catch (e) {
      // TODO 提示返回的错误消息
      console.error('error')
      console.error(e)
    }
  }

  // 用于保存表单项原始提示样式
  const origin = {}

  /**
   * 表单验证
   *
   * @param data
   * @returns {Promise<*>}
   */
  async function validate(data) {
    return new Promise((resolve, reject) => {
      // 验证规则
      const rules = {
        email: ({email}, callback) => !email && callback('请输入邮箱'),
        password: ({password}, callback) => !password && callback('请输入密码'),
        password_confirm: ({password, password_confirm}, callback) => {
          if (!password_confirm) return callback('请输入确认密码')
          if (password !== password_confirm) return callback('两次密码不一致')
        }
      }

      let hasErr = false

      for (const key in data) {
        // 存储错误消息
        let msg = null

        // 验证并提取错误消息
        rules[key](data, (err) => (msg = err))

        // 提示DOM对象, 通过修改提示内容及样式优化用户体验
        const tipDom = $('form').find(`input[name=${key}]`).siblings('span.tips')

        // 保存初始化提示样式
        if (!origin[key]) {
          origin[key] = {html: tipDom.html(), color: tipDom.css('color')}
        }

        // 渲染错误消息及样式
        tipDom.html(msg || origin[key].html).css('color', msg ? 'red' : origin[key].color)

        hasErr = hasErr || msg !== null
      }

      // 表单中但凡有一项验证错误了则reject
      hasErr ? reject() : resolve()
    })
  }
</script>

</html>
